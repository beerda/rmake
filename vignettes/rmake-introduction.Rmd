---
title: "Introduction to rmake"
author: "Michal Burda"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Introduction to rmake}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r intro-setup, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  fig.width = 7,
  fig.height = 5
)
```

## Introduction

R is a mature scripting language for statistical computations and data processing. An important advantage of R is that it allows writing **repeatable** statistical analyses by programming all steps of data processing in scripts, which allows re-executing the whole process after any change in data or processing steps.

There are several useful packages for R to obtain repeatability of statistical computations, such as `knitr` and `rmarkdown`. These tools allow writing R scripts that generate reports combining text with tables and figures generated from data.

However, if analyses grow in complexity, manual re-execution of the whole process may become tedious, prone to errors, and very demanding computationally. Complex analyses typically involve:

- Many pre-processing steps on large datasets
- Repetitive execution of commands differing only in parameters
- Production of multiple output files in various formats

It is inefficient to re-run all pre-processing steps repeatedly to refresh the final report after any change. A caching mechanism provided by `knitr` is helpful but limited to a single report. Splitting complex analyses into several parts and saving intermediate results into files is rational, but brings another challenge: **management of dependencies** between inputs, outputs, and underlying scripts.

This is where **Make** comes in. Make is a tool that controls the generation of files from source data and script files by reading dependencies from a `Makefile` and comparing timestamps to determine which files need to be refreshed.

The `rmake` package provides tools for easy generation of Makefiles for statistical and data manipulation tasks in R.

## Key Features

The main features of `rmake` are:

- Use of the well-known Make tool
- Easy definitions of file dependencies in the R language
- High flexibility through parameterized execution and programmatic rule generation
- Simple, short code thanks to the `%>>%` pipeline operator and templating
- Support for R scripts and R markdown files
- Extensibility for user-defined rule types
- Isolated and parallel execution via Make's parallel processing
- Support for all platforms: Unix (Linux), MacOS, Windows, and Solaris
- Compatibility with RStudio

## Installation and Setup

### Installation

Install from CRAN:
```{r intro-install, eval=FALSE}
install.packages("rmake")
```

Or install the development version from GitHub:
```{r install_dev, eval=FALSE}
install.packages("devtools")
devtools::install_github("beerda/rmake")
```

### System Requirements

- R environment (version 3.5.0 or higher)
- GNU Make or compatible make tool
  - Linux: Usually pre-installed
  - macOS: Pre-installed or via Xcode
  - Windows: Install Rtools

### Environment Variables

For `rmake` to work properly, `R_HOME` and `R_ARCH` environment variables must be set correctly. The `R_HOME` variable indicates the directory where R is installed. These variables are automatically set when executing Make from within an R session (e.g., from RStudio).

#### When do you need to set these variables?

When executing `make` from the command line (outside of R), you may need to set these environment variables manually.

#### Finding R_HOME

To find the correct value for your system, run this in R:

```{r find_rhome, eval=FALSE}
R.home()
```

You can also check the current values of these environment variables:

```{r check_vars, eval=FALSE}
Sys.getenv("R_HOME")
```

#### Setting Environment Variables

**On Linux/macOS:**
```bash
export R_HOME=/usr/lib/R  # Use the path from R.home()
```

**On Windows (Command Prompt):**
```cmd
set R_HOME=C:\Program Files\R\R-4.3.0
```

**On Windows (PowerShell):**
```powershell
$env:R_HOME = "C:\Program Files\R\R-4.3.0"
```

For permanent setup, add the export commands to your shell configuration file (`.bashrc`, `.zshrc`, etc. on Unix-like systems, or configure system environment variables on Windows through System Properties > Advanced > Environment Variables).

For more information on R environment variables, see the [official R documentation](https://stat.ethz.ch/R-manual/R-devel/library/base/html/EnvVar.html).

## Basic Usage

For information on project initialization and running the build process, see the "rmake Project Management" vignette.

### Adding a Build Rule

Suppose we have `data.csv` and want to compute sums using `script.R` to create `sums.csv`.

The `script.R` file:
```{r script_ex, eval=FALSE}
d <- read.csv("data.csv")
sums <- data.frame(ID = "sum",
                   V1 = sum(d$V1),
                   V2 = sum(d$V2))
write.csv(sums, "sums.csv", row.names = FALSE)
```

Update `Makefile.R`:
```{r rule_basic_ex, eval=FALSE}
library(rmake)
job <- list(rRule(target = "sums.csv", 
                  script = "script.R", 
                  depends = "data.csv"))
makefile(job, "Makefile")
```

Run make to execute the script:
```{r make_ex, eval=FALSE}
make()
```

For detailed information on all available rule types (including `markdownRule()`, `knitrRule()`, `copyRule()`, `depRule()`, `subdirRule()`, and custom rules), see the "Build Rules" vignette.

### The Pipe Operator

Rule chains can be written more concisely using the `%>>%` pipe operator:

```{r pipe_intro}
library(rmake)
job <- "data.csv" %>>% rRule("script.R") %>>% "sums.csv"
```

Every second element (positions 2, 4, 6, ...) must be a rule-creating function. The function receives `depends` from the preceding element and `target` from the following element.

Example with multiple files:
```{r pipe_multi, eval=FALSE}
job <- c('in1.csv', 'in2.csv') %>>%
  rRule('run.R') %>>%
  c('out1.csv', 'out2.csv')
```

Example with complex dependencies:
```{r pipe_complex}
chain1 <- "data1.csv" %>>% rRule("preprocess1.R") %>>% "intermed1.rds"
chain2 <- "data2.csv" %>>% rRule("preprocess2.R") %>>% "intermed2.rds"
chain3 <- c("intermed1.rds", "intermed2.rds") %>>% 
  rRule("merge.R") %>>% "merged.rds" %>>% 
  markdownRule("report.Rmd") %>>% "report.pdf"

job <- c(chain1, chain2, chain3)
```

### Visualization

Print rules to see dependencies:
```{r print_job}
print(job)
```

Visualize the dependency graph:
```{r intro-visualize, eval=FALSE}
visualize(job, legend = FALSE)
```

The graph shows:
- **Squares**: Data files
- **Diamonds**: Main script files
- **Ovals**: Rules
- **Arrows**: Dependencies

## Advanced Usage

### Tasks

Tasks allow grouping rules that can be executed together. Each rule is a member of the `"all"` task by default. Rules can belong to multiple tasks.

Execute a task:
```{r task_ex, eval=FALSE}
make('all')
make('preview')
```

Assign rules to tasks:
```{r task_assign, eval=FALSE}
library(rmake)
job <- c(
  "data.csv" %>>% rRule("preprocess.R") %>>% "data.rds",
  "data.rds" %>>% markdownRule("preview.Rmd", task = "preview") %>>% 
    "preview.pdf",
  "data.rds" %>>% markdownRule("final.Rmd", task = "final") %>>% 
    "final.pdf"
)
makefile(job, "Makefile")
```

Running `make("preview")` creates `data.rds` and `preview.pdf` but not `final.pdf`.

### Parameterized Execution

Pass parameters to scripts via the `params` argument:

```{r params_ex, eval=FALSE}
library(rmake)
job <- c(
  "data.csv" %>>% rRule("fit.R", params = list(alpha = 0.1)) %>>% "out-0.1.rds",
  "data.csv" %>>% rRule("fit.R", params = list(alpha = 0.2)) %>>% "out-0.2.rds",
  "data.csv" %>>% rRule("fit.R", params = list(alpha = 0.3)) %>>% "out-0.3.rds"
)
makefile(job, "Makefile")
```

Parameters are available in scripts as the `params` global variable:
```{r params_script, eval=FALSE}
# fit.R
str(params)
# List of 5
#  $ .target : chr "out-0.1.rds"
#  $ .script : chr "fit.R"
#  $ .depends: chr "data.csv"
#  $ .task   : chr "all"
#  $ alpha   : num 0.1
```

Use `getParam()` to access parameters safely:
```{r getparam_ex, eval=FALSE}
# fit.R
library(rmake)

dataName <- getParam(".depends")
resultName <- getParam(".target")
alpha <- getParam("alpha")

# Use parameters...
cat("Processing with alpha =", alpha, "\n")
```

`getParam()` with default values:
```{r getparam_default, eval=FALSE}
dataName <- getParam(".depends", "data.csv")
resultName <- getParam(".target", "result.rds")
alpha <- getParam("alpha", 0.2)
```

### Rule Templates

Rule templates avoid repetitive rule definitions using `expandTemplate()`:

```{r template_simple, eval=FALSE}
tmpl <- "data-$[NUM].csv" %>>% 
  rRule("process.R") %>>% 
  "result-$[NUM].csv"
variants <- data.frame(NUM = 1:99)
job <- expandTemplate(tmpl, variants)
```

This creates 99 rules, one for each value of `NUM`.

Template with multiple variables:
```{r template_multi}
variants <- expand.grid(DATA = c("dataSimple", "dataComplex"),
                        TYPE = c("lm", "rf", "nnet"))
print(variants)

tmpl <- "$[DATA].csv" %>>% 
  rRule("fit-$[TYPE].R") %>>%
  "result-$[DATA]_$[TYPE].csv"
job <- expandTemplate(tmpl, variants)
print(job)
```

Duplicate rules are automatically removed:
```{r template_dup}
tmpl <- "data.csv" %>>%
  rRule("pre.R") %>>% "pre.rds" %>>%
  rRule("comp.R", params = list(alpha = "$[NUM]")) %>>% 
  "result-$[NUM].csv"
variants <- data.frame(NUM = 1:5)
job <- expandTemplate(tmpl, variants)
print(job)
```

Warning: Different rules producing the same target will cause an error:
```{r template_error, error=TRUE}
tmpl <- "data-$[TYPE].csv" %>>% 
  markdownRule("report.Rmd") %>>% "report.pdf"
variants <- data.frame(TYPE = c("a", "b", "c"))
job <- expandTemplate(tmpl, variants)
print(job)

# This would error:
# makefile(job)
# Error: Multiple rules detected for the same target
```

## Summary

The `rmake` package provides an easy but powerful way to manage complex data manipulation processes in R using the Make utility. Key features include:

- Pipeline operator `%>>%` for readable rule chains
- Parameterized rules for flexible processing
- Rule templates for efficient rule generation
- Support for R scripts, R Markdown, and custom rules
- Parallel execution capability
- Visualization of dependencies
- Cross-platform compatibility

For more information, see:
- Package documentation: `?rmake`
- GitHub repository: https://github.com/beerda/rmake
- Submit issues: https://github.com/beerda/rmake/issues

## References

- Xie, Y. (2015). *Dynamic Documents with R and knitr* (2nd ed.). Chapman and Hall/CRC.
- Allaire, J.J., et al. (2023). *rmarkdown: Dynamic Documents for R*. R package.
- Stallman, R.M., McGrath, R., & Smith, P.D. (2023). *GNU Make: A Program for Directing Recompilation*. Free Software Foundation.
